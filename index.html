<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>OC Location</title>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css"
          integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ=="
          crossorigin=""/>
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <link rel="stylesheet" href="oc_location.css"/>

</head>
<body>

<input id="location-output">
<div id="location-form" class="row"></div>

<p>dep</p>
<input id="dep">

<p>city</p>
<input id="city">

<p>address</p>
<input id="address">


<p>New array: <span id="demo"></span></p>


<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"
        integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw=="
        crossorigin=""></script>
<script src="oc_location.js"></script>
<script>

    var accentMap = {
        "á": "a",
        "â": "a",
        "é": "e",
        "è": "e",
        "ë": "e",
        "ê": "e",
        "ù": "u",
        "î": "i",
        "ô": "o",
        "û": "u",
        "ï": "i",
        "ç": "c",
    };
    var normalize = function (term) {
        var ret = "";
        for (var i = 0; i < term.length; i++) {
            ret += accentMap[term.charAt(i)] || term.charAt(i);
        }
        return ret;
    };

    var depCode;
    var dep;
    var cityCode;
    var locationData;
    var locationDataIsValide = false;
    var locationMap;

    depAutocomplete();

    function depAutocomplete() {
        var features = [];
        $.ajax({
            url: "https://geo.api.gouv.fr/departements?fields=nom,code",
            dataType: "json",
            success: function (data) {
                data.map(function (item) {
                    features.push({
                        value: item.code + ' ' + item.nom,
                        label: item.code + ' ' + item.nom,
                        dep: item.code,
                    });
                });

                autocomplete(features);
            }
        });

        function autocomplete(features) {
            $("#dep").autocomplete({
                source: function (request, response) {
                    var matcher = new RegExp($.ui.autocomplete.escapeRegex(request.term), "i");
                    response($.grep(features, function (value) {
                        value = value.label || value.value || value;
                        return matcher.test(value) || matcher.test(normalize(value));
                    }));
                },
                minLength: 2,
                select: function (event, ui) {
                    dep = ui.item.dep;
                    cityAutocomplete()
                }
            });
        }

    }

    function cityAutocomplete() {

        var features = [];
        $.ajax({
            url: "https://geo.api.gouv.fr/departements/"+ dep +"/communes?fields=nom,code,codesPostaux&format=json&geometry=centre",
            dataType: "json",
            success: function (data) {
                data.map(function (item) {
                    features.push({
                        value: item.nom,
                        label: item.nom,
                        code: item.code,
                        postCode : item.codesPostaux[0]
                    });
                });
                autocomplete(features);
            }
        });

        function autocomplete(features) {
            $("#city").autocomplete({
                source: function (request, response) {
                    var matcher = new RegExp($.ui.autocomplete.escapeRegex(request.term), "i");
                    response($.grep(features, function (value) {
                        value = value.label || value.value || value;
                        return matcher.test(value) || matcher.test(normalize(value));
                    }));
                },
                minLength: 3,
                select: function (event, ui) {
                    cityCode = ui.item.code;
                    $('#demo').text( ui.item.code );
                    $('#demo').text( ui.item.postCode );
                }
            });
        }
    }





</script>


</body>
</html>